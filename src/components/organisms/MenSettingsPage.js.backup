import React, { useState } from "react";
import {
    Box,
    Typography,
    Divider,
    Button,
    TextField,
    Stepper,
    Step,
    StepLabel,
    FormControl,
    InputLabel,
    Select,
    MenuItem,
    Paper,
    styled,
} from "@mui/material";
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import RestartAltIcon from "@mui/icons-material/RestartAlt";
import { toast, ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import { useNavigate } from "react-router-dom";

// Constants for styling - matching the login theme
const NAVY_BLUE_MAIN = "#0A192F";
const NAVY_BLUE_LIGHT = "#112240";
const NAVY_BLUE_DARK = "#020c1b";
const GOLD_MAIN = "#B8860B";
const GOLD_LIGHT = "#DAA520";
const GOLD_DARK = "#8B6914";

const steps = ["User Details", "Academics", "Profile Details"];
const mentorIDRegex = /^BNM\d{4}$/;
const emailRegex = /^[a-zA-Z0-9._%+-]+@bnmit\.in$/;

// Custom styled components
const GoldStepLabel = styled(StepLabel)(({ theme }) => ({
    '& .MuiStepLabel-label': {
        color: 'rgba(255, 255, 255, 0.7)',
        '&.Mui-active': {
            color: GOLD_LIGHT,
        },
        '&.Mui-completed': {
            color: GOLD_LIGHT,
        }
    },
    '& .MuiStepIcon-root': {
        color: 'rgba(255, 255, 255, 0.3)',
        '&.Mui-active': {
            color: GOLD_MAIN,
        },
        '&.Mui-completed': {
            color: GOLD_LIGHT,
        }
    }
}));

const GlassPaper = styled(Paper)(({ theme }) => ({
    background: `rgba(17, 34, 64, 0.8)`,
    backdropFilter: 'blur(5px)',
    borderRadius: '10px',
    boxShadow: `0 10px 20px rgba(0, 0, 0, 0.3), 0 0 10px ${GOLD_MAIN}40`,
    border: `1px solid ${GOLD_MAIN}30`,
    padding: '30px',
    transition: 'all 0.3s ease',
    '&:hover': {
        boxShadow: `0 15px 30px rgba(0, 0, 0, 0.4), 0 0 15px ${GOLD_MAIN}60`,
    }
}));

const GoldTextField = styled(TextField)(({ theme }) => ({
    '& .MuiInputBase-root': {
        color: 'white',
        background: `rgba(10, 25, 47, 0.5)`,
        borderRadius: '5px',
        backdropFilter: 'blur(5px)',
    },
    '& .MuiInputLabel-root': {
        color: 'rgba(255, 255, 255, 0.7)',
    },
    '& .MuiInputLabel-root.Mui-focused': {
        color: GOLD_LIGHT,
    },
    '& .MuiOutlinedInput-root': {
        '& fieldset': {
            borderColor: 'rgba(255, 255, 255, 0.2)',
        },
        '&:hover fieldset': {
            borderColor: 'rgba(255, 255, 255, 0.3)',
        },
        '&.Mui-focused fieldset': {
            borderColor: GOLD_MAIN,
        },
    },
}));

const GoldSelect = styled(Select)(({ theme }) => ({
    color: 'white',
    background: `rgba(10, 25, 47, 0.5)`,
    borderRadius: '5px',
    backdropFilter: 'blur(5px)',
    '& .MuiOutlinedInput-notchedOutline': {
        borderColor: 'rgba(255, 255, 255, 0.2)',
    },
    '&:hover .MuiOutlinedInput-notchedOutline': {
        borderColor: 'rgba(255, 255, 255, 0.3)',
    },
    '&.Mui-focused .MuiOutlinedInput-notchedOutline': {
        borderColor: GOLD_MAIN,
    },
    '& .MuiSvgIcon-root': {
        color: 'white',
    }
}));

const GoldButton = styled(Button)(({ theme }) => ({
    background: `linear-gradient(135deg, ${GOLD_MAIN}, ${GOLD_LIGHT})`,
    color: 'white',
    fontWeight: 'bold',
    padding: '10px 20px',
    borderRadius: '5px',
    boxShadow: `0 4px 6px rgba(0, 0, 0, 0.2), 0 0 10px ${GOLD_MAIN}20`,
    '&:hover': {
        background: `linear-gradient(135deg, ${GOLD_LIGHT}, ${GOLD_MAIN})`,
        boxShadow: `0 6px 10px rgba(0, 0, 0, 0.3), 0 0 15px ${GOLD_MAIN}40`,
    }
}));

const MenSettingsPage = () => {
    const [activeStep, setActiveStep] = useState(0);
    const navigate = useNavigate();
    const [formData, setFormData] = useState({
        fullName: "",
        mentorID: "",
        phoneNumber: "",
        alternatePhoneNumber: "",
        email: "",
        gender: "",
        employeeIn: "",
        selectedMajors: "",
        bio: "",
        tech: ""
    });

    const [formErrors, setFormErrors] = useState({});

    const handleInputChange = (field, value) => {
        setFormData((prevData) => ({
            ...prevData,
            [field]: value
        }));
        // Clear the error as soon as the field is corrected
        setFormErrors((prevErrors) => ({
            ...prevErrors,
            [field]: ""
        }));
    };


    const validateStep = () => {
        const errors = {};

        if (!formData.fullName) errors.fullName = "fullName is required.";
        if (!formData.mentorID) errors.mentorID = "Mentor ID is required";
        else if (!mentorIDRegex.test(formData.mentorID)) {
            errors.mentorID = "Please enter a valid Mentor ID (e.g., BNM0001)";
        }

        if (!formData.phoneNumber) {
            errors.phoneNumber = "Mobile Number is required.";
        } else if (!/^\d{10}$/.test(formData.phoneNumber)) {
            errors.phoneNumber = "Enter a valid 10-digit Mobile Number.";
        }

        if (!formData.email) {
            errors.email = "Email is required";
        } else if (!emailRegex.test(formData.email)) {
            errors.email = "Please enter a valid email (e.g., example@bnmit.in)";
        }

        if (!formData.gender) errors.gender = "Gender is required.";

        setFormErrors(errors);

        // Return true only if no errors exist
        return Object.keys(errors).length === 0;
    };

    const handleNext = () => {
        if (validateStep()) {
            setActiveStep((prev) => prev + 1);
        } else {
            setTimeout(() => {
                toast.warn("Please correct the errors before proceeding.");
            }, 200); // Delay warning toast slightly to ensure state updates
        }
    };

    const handleReset = () => {
        setActiveStep(0);
        setFormData({
            fullName: "",
            mentorID: "",
            phoneNumber: "",
            alternatePhoneNumber: "",
            email: "",
            gender: "",
            employeeIn: "",
            selectedMajors: "",
            bio: "",
            tech: ""
        });
        setFormErrors({});
    };

    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
            const response = await fetch('http://localhost:5002/api/mentor/details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });

            if (response.ok) {
                toast.success("Form submitted successfully!");
                setTimeout(() => navigate("/dashboard-mentor"), 1000);
            } else {
                const errorData = await response.json();
                toast.error(errorData.message || "An error occurred.");
            }
        } catch (error) {
            toast.error("Error submitting form.");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <Box
            sx={{
                display: "flex",
                flexDirection: "column",
                alignItems: "center",
                padding: "24px",
                position: "relative",
                zIndex: 1,
            }}
            className="fade-in-up"
        >
            <ToastContainer position="top-right" autoClose={3000} />
            
            {/* Page Title */}
            <Typography 
                variant="h4" 
                sx={{ 
                    mb: 4, 
                    color: "white", 
                    fontWeight: "bold",
                    textShadow: `0 0 10px ${GOLD_MAIN}40`
                }}
                className="scale-in"
            >
                Settings
            </Typography>
            
            {/* Stepper */}
            <Stepper 
                activeStep={activeStep} 
                sx={{ 
                    width: { xs: "100%", sm: "90%", md: "70%" }, 
                    mb: 4,
                    '& .MuiStepConnector-line': {
                        borderColor: `${GOLD_MAIN}40`
                    }
                }}
                className="slide-in-right"
            >
                {steps.map((label) => (
                    <Step key={label}>
                        <GoldStepLabel>{label}</GoldStepLabel>
                    </Step>
                ))}
            </Stepper>

            {/* Step Content */}
            <GlassPaper
                sx={{
                    width: { xs: "100%", sm: "90%", md: "70%" },
                }}
            >
                {activeStep === 0 && (
                    <>
                        <Typography variant="h6" sx={{ fontWeight: "bold", mb: 2, color: GOLD_LIGHT }}>
                            User Details
                        </Typography>
                        <Divider sx={{ mb: 3, borderColor: `${GOLD_MAIN}40` }} />
                        <Box sx={{ display: "flex", flexDirection: "column", gap: 2 }}>
                            <Box sx={{ display: "flex", gap: 2, flexWrap: "wrap" }}>
                                <TextField
                                    label="Name"
                                    variant="outlined"
                                    fullWidth
                                    value={formData.fullName}
                                    onChange={(e) => handleInputChange("fullName", e.target.value)}
                                    error={!!formErrors.fullName}
                                    helperText={formErrors.fullName}
                                />
                                <TextField
                                    label="Mentor ID"
                                    variant="outlined"
                                    fullWidth
                                    value={formData.mentorID.toUpperCase()} // Ensure input is displayed in uppercase
                                    onChange={(e) => {
                                        const uppercasedValue = e.target.value.toUpperCase();
                                        handleInputChange("mentorID", uppercasedValue);
                                    }}
                                    error={!!formErrors.mentorID}
                                    helperText={formErrors.mentorID}
                                />
                            </Box>
                            <Box sx={{ display: "flex", gap: 2 }}>
                                <TextField
                                    label="Mobile Number"
                                    variant="outlined"
                                    fullWidth
                                    value={formData.phoneNumber}
                                    onChange={(e) => handleInputChange("phoneNumber", e.target.value)}
                                    error={!!formErrors.phoneNumber}
                                    helperText={formErrors.phoneNumber}
                                />
                                <TextField
                                    label="Alternate Mobile Number"
                                    variant="outlined"
                                    fullWidth
                                    value={formData.alternatePhoneNumber}
                                    onChange={(e) =>
                                        handleInputChange("alternatePhoneNumber", e.target.value)
                                    }
                                />
                            </Box>
                            <TextField
                                label="College Email ID"
                                variant="outlined"
                                fullWidth
                                value={formData.email}
                                onChange={(e) => handleInputChange("email", e.target.value)}
                                error={!!formErrors.email}
                                helperText={formErrors.email}
                            />
                            <Box sx={{ display: "flex", gap: 2 }}>
                                <FormControl fullWidth>
                                    <InputLabel id="gender-label">Gender</InputLabel>
                                    <Select
                                        labelId="gender-label"
                                        id="gender-select"
                                        value={formData.gender}
                                        onChange={(e) => handleInputChange("gender", e.target.value)}
                                        error={!!formErrors.gender}
                                    >
                                        <MenuItem value="">Select Gender</MenuItem> {/* Default empty option */}
                                        <MenuItem value="Male">Male</MenuItem>
                                        <MenuItem value="Female">Female</MenuItem>
                                        <MenuItem value="Others">Others</MenuItem>
                                    </Select>
                                    {formErrors.gender && (
                                        <Typography color="error" variant="caption">
                                            {formErrors.gender}
                                        </Typography>
                                    )}
                                </FormControl>
                            </Box>
                        </Box>
                    </>
                )}

                {activeStep === 1 && (
                    <>
                        <Typography variant="h6" sx={{ fontWeight: "bold", mb: 2, fontFamily: "Courier" }}>
                            Academics
                        </Typography>
                        <Divider sx={{ mb: 3 }} />

                        {/* College */}
                        <FormControl fullWidth sx={{ mb: 2 }}>
                            <Typography fontFamily="Courier">Employee in</Typography>
                            <TextField
                                placeholder="Enter your college name"
                                label="College Name"
                                variant="outlined"
                                fullWidth
                                value={formData.employeeIn}
                                onChange={(e) => handleInputChange("employeeIn", e.target.value)}
                                error={!!formErrors.employeeIn}
                                helperText={formErrors.employeeIn}
                            />
                        </FormControl>

                        {/* Majors */}
                        <FormControl fullWidth>
                            <Typography id="majors-label" fontFamily="Courier">
                                Choose your major
                            </Typography>
                            <TextField
                                placeholder="Graduated Majors"
                                label="Majors"
                                variant="outlined"
                                fullWidth
                                value={formData.selectedMajors}
                                onChange={(e) => handleInputChange("selectedMajors", e.target.value)}
                                error={!!formErrors.selectedMajors}
                                helperText={formErrors.selectedMajors}
                            />
                        </FormControl>
                        {/* Tech Stack */}
                        <FormControl fullWidth
                            sx={{ mt: 3 }}>
                            <Typography id="majors-label" fontFamily="Courier">
                                Tech Stacks
                            </Typography>
                            <TextField
                                placeholder="Tech Stacks that I am fluent with"
                                label="Fluent Tech Stacks"
                                variant="outlined"
                                fullWidth
                                value={formData.tech}
                                onChange={(e) => handleInputChange("tech", e.target.value)}
                                error={!!formErrors.tech}
                                helperText={formErrors.tech}
                            />
                        </FormControl>
                    </>
                )}
                {activeStep === 2 && (
                    <>
                        <Typography variant="h6" sx={{ fontWeight: "bold", mb: 1, fontFamily: "Courier" }}>
                            Profile Details
                        </Typography>
                        <Divider sx={{ mb: 3 }} />
                        <Typography variant="body1" sx={{ mb: 1, fontFamily: "Courier" }}>
                            Short Bio
                        </Typography>
                        <TextField
                            fullWidth
                            label="Bio"
                            placeholder="How would I like to contribute..."
                            multiline
                            variant="outlined"
                            sx={{ mb: 3 }}
                            value={formData.bio}
                            onChange={(e) => handleInputChange("bio", e.target.value)}
                            error={!!formErrors.bio}
                            helperText={formErrors.bio}
                        />
                    </>
                )}
            </Box>

            <Box>
                {/* Navigation Buttons */}
                <Box sx={{ display: "flex", flexDirection: "row", pt: 2, mt: 3 }}>
                    <Button
                        color="inherit"
                        disabled={activeStep === 0}
                        onClick={() => setActiveStep((prev) => prev - 1)}
                        sx={{ mr: 1 }}
                    >
                        Back
                    </Button>
                    <Box sx={{ flex: "1 1 auto" }} />
                    {activeStep < steps.length - 1 ? (
                        <Button onClick={handleNext} variant="contained">
                            Next
                        </Button>
                    ) : (
                        <>
                            <Button onClick={handleReset} variant="contained" color="secondary" startIcon={<RestartAltIcon />} sx={{ mr: 2 }}>
                                Reset
                            </Button>
                            <Button
                                onClick={handleSubmit}
                                variant="contained"
                                color="primary"
                                endIcon={<CheckCircleIcon />}
                                disabled={isSubmitting} // Disable during submission
                            >
                                {isSubmitting ? "Submitting..." : "Submit"}
                            </Button>
                        </>
                    )}
                </Box>
            </Box>
        </GlassPaper>
    );
};

export default MenSettingsPage;
